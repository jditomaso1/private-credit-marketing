<script>
  // Redirect helper: send user back to the page they originally tried to view
  function getNextPath() {
    const url = new URL(window.location.href);
    const next = url.searchParams.get("next");
    // allow only same-site paths to avoid open-redirects
    if (next && next.startsWith("/")) return next;
    return "/orion.html"; // fallback if no next provided
  }

  const form = document.getElementById("inviteLogin");
  const msg  = document.getElementById("msg");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    msg.style.color = "#444";
    msg.textContent = "Signing in…";

    try {
      const fd = new FormData(form);
      const data = {
        email: (fd.get("email") || "").trim(),
        password: (fd.get("password") || "").trim()
      };

      const res = await fetch("/api/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
        credentials: "include"
      });

      if (res.ok) {
        window.location.href = getNextPath();   // ← send back to original page
      } else {
        const txt = await res.text();
        try {
          const j = JSON.parse(txt);
          msg.style.color = "#b00020";
          msg.textContent = j.error || "login failed";
        } catch {
          msg.style.color = "#b00020";
          msg.textContent = txt || "login failed";
        }
      }
    } catch (err) {
      console.error(err);
      msg.style.color = "#b00020";
      msg.textContent = "Network error — please try again";
    }
  });
</script>
