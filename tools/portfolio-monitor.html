<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Portfolio Monitor | Private Credit AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Monitor portfolio exposure, covenant status, and concentrations. Paste or upload CSV; get alerts and quick charts." />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="icon" type="image/png" href="/img/favicon.png?v=8" />
  <style>
    body{font-family:Poppins,sans-serif;margin:0;background:#f4f4f4;color:#333}
    .page{max-width:1100px;margin:24px auto;padding:20px}
    .tool-tabs{margin:0 0 16px;display:flex;gap:8px;flex-wrap:wrap}
    .tool-tab{display:inline-block;padding:10px 14px;border:1px solid #ddd;border-radius:8px;background:#fff;text-decoration:none;color:#111;font-size:14px}
    .tool-tab.active{background:#111;color:#fff;border-color:#111}
    .card{background:#fff;border:1px solid #e8e8e8;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.05);padding:18px}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(220px,1fr));gap:12px}
    .metric{background:#fff;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.06);padding:14px}
    .metric .k{color:#666;font-size:.85rem;margin-bottom:4px}
    .metric .v{font-size:1.25rem;font-weight:700}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .btn{padding:10px 14px;border:none;border-radius:10px;background:#2c7cf1;color:#fff;cursor:pointer;font-weight:600}
    .btn.alt{background:#10b981}
    .btn.ghost{background:#fff;color:#2c7cf1;border:1px solid #cfe0ff}
    input[type="number"], input[type="text"], input[type="file"], textarea, select{
      padding:8px;border:1px solid #ddd;border-radius:10px
    }
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #f0f0f0;font-size:.95rem}
    th{background:#f7f7f7;text-align:left}
    .pill{font-size:.75rem;background:#f0f2f5;border:1px solid #e1e5ea;border-radius:999px;padding:4px 8px}
    .alert{display:flex;gap:8px;align-items:flex-start;padding:10px;border:1px solid #fde68a;background:#fffbeb;border-radius:10px}
    .alert.danger{border-color:#fecaca;background:#fff1f2}
    canvas{width:100%;height:260px;display:block}
    .charts{display:grid;grid-template-columns:repeat(2,minmax(260px,1fr));gap:12px}
    @media (max-width:900px){ .charts{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div id="site-header"></div>

  <main class="page">
    <!-- Tabs ABOVE heading -->
    <nav class="tool-tabs" aria-label="Tools">
      <a class="tool-tab" href="/tools/index.html">Tools</a>
      <a class="tool-tab" href="/tools/media-hub.html">Media Hub</a>
      <a class="tool-tab" href="/tools/irr-calculator.html">IRR Calculator</a>
      <a class="tool-tab" href="/tools/yield-curve.html">Yield Curve</a>
      <a class="tool-tab" href="/tools/credit-decoder.html">Credit Decoder</a>
      <a class="tool-tab" href="/tools/loan-pricing.html">Loan Pricing</a>
      <a class="tool-tab" href="/tools/covenant-checker.html">Covenant Checker</a>
      <a class="tool-tab" href="/tools/shadow-ratings-basic.html">Shadow Ratings</a>
      <a class="tool-tab" href="/tools/portfolio-monitor.html">Portfolio Monitor</a>
      <a class="tool-tab" href="/tools/compliance-tracking.html">Compliance Tracking</a>
    </nav>
    <script>
      (function(){
        const here = location.pathname.replace(/\/+$/,'');
        document.querySelectorAll('.tool-tab').forEach(a=>{
          if(a.getAttribute('href')===here){ a.classList.add('active'); }
        });
      })();
    </script>

    <h1 style="margin:0 0 8px;font-size:26px;font-weight:700;">Portfolio Monitor</h1>
    <p style="margin:0 0 16px;color:#666;">Paste/upload a CSV of deals to track exposure, covenant status, concentrations, and quick alerts.</p>

    <!-- Controls -->
    <div class="card" style="margin:12px 0;">
      <div class="controls">
        <div>
          <label for="file">Upload CSV</label><br>
          <input id="file" type="file" accept=".csv">
        </div>
        <div>
          <label for="sep">Separator</label><br>
          <select id="sep">
            <option value=",">Comma</option>
            <option value=";">Semicolon</option>
            <option value="tab">Tab</option>
          </select>
        </div>
        <div>
          <label for="recency">Cert stale if &gt; days</label><br>
          <input id="recency" type="number" value="90" min="1" style="width:120px">
        </div>
        <div>
          <label for="conc">Concentration warn at %</label><br>
          <input id="conc" type="number" value="20" min="1" style="width:140px">
        </div>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button id="loadSample" class="btn alt">Load Sample</button>
          <button id="parse" class="btn">Parse Data</button>
          <button id="download" class="btn ghost">Download CSV</button>
        </div>
      </div>
      <div style="margin-top:10px">
        <label for="raw">Or paste CSV here</label>
        <textarea id="raw" rows="6" placeholder="Borrower,Sector,Exposure,Status,Test,Threshold,Value,AsOf
Acme Corp,Healthcare,2500000,In Compliance,Net Leverage,4.5x,3.8x,2025-08-15
Bravo LLC,Software,3200000,At Risk,FCCR,1.2x,1.25x,2025-07-20
Charlie Inc,Industrials,1800000,Breach,Net Leverage,4.5x,5.1x,2025-06-30" style="width:100%;"></textarea>
      </div>
      <p style="color:#666;margin:6px 0 0;"><small>
        Expected columns (order flexible): <span class="pill">Borrower</span> <span class="pill">Sector</span> <span class="pill">Exposure</span> <span class="pill">Status</span> <span class="pill">Test</span> <span class="pill">Threshold</span> <span class="pill">Value</span> <span class="pill">AsOf (YYYY-MM-DD)</span>
      </small></p>
    </div>

    <!-- Alerts -->
    <div id="alerts"></div>

    <!-- Metrics -->
    <div class="grid" style="margin:12px 0;">
      <div class="metric"><div class="k">Total Exposure</div><div id="m_total" class="v">–</div></div>
      <div class="metric"><div class="k">Borrowers</div><div id="m_borrowers" class="v">–</div></div>
      <div class="metric"><div class="k">Sectors</div><div id="m_sectors" class="v">–</div></div>
      <div class="metric"><div class="k">Breaches</div><div id="m_breaches" class="v">–</div></div>
      <div class="metric"><div class="k">At Risk</div><div id="m_risk" class="v">–</div></div>
      <div class="metric"><div class="k">Top Borrower Concentration</div><div id="m_topconc" class="v">–</div></div>
    </div>

    <!-- Charts -->
    <div class="charts" style="margin:12px 0;">
      <div class="card">
        <h3 style="margin:0 0 8px;font-size:18px">Exposure by Sector</h3>
        <canvas id="chartSector" width="500" height="260"></canvas>
      </div>
      <div class="card">
        <h3 style="margin:0 0 8px;font-size:18px">Status Counts</h3>
        <canvas id="chartStatus" width="500" height="260"></canvas>
      </div>
    </div>

    <!-- Table -->
    <div class="card" style="margin:12px 0;">
      <div style="overflow:auto">
        <table id="table">
          <thead>
            <tr>
              <th>#</th>
              <th>Borrower</th>
              <th>Sector</th>
              <th style="text-align:right">Exposure</th>
              <th>Status</th>
              <th>Test</th>
              <th>Threshold</th>
              <th>Value</th>
              <th>As Of</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </main>

  <div id="site-footer"></div>
  <script src="/includes/include.js"></script>

  <script>
  (function(){
    // ---------- Utilities ----------
    const $ = id => document.getElementById(id);
    const fmt = n => isFinite(n) ? (Math.abs(n)>=1000 ? n.toLocaleString(undefined,{maximumFractionDigits:0}) : n.toFixed(0)) : '–';
    const money = n => isFinite(n) ? '$' + Number(n).toLocaleString(undefined,{maximumFractionDigits:0}) : '–';
    const parseNumber = s => {
      if (s==null) return NaN;
      const t = (''+s).replace(/[\$,]/g,'').trim();
      const x = parseFloat(t);
      return isNaN(x) ? NaN : x;
    };
    const today = new Date();

    function splitRows(text, sep){
      if(sep==='tab') sep = '\t';
      // quick-n-clean CSV: handles commas inside quotes
      const lines = text.replace(/\r/g,'').split('\n').filter(Boolean);
      return lines.map(line=>{
        const out = [];
        let cur = '', inQ = false;
        for(let i=0;i<line.length;i++){
          const ch=line[i];
          if(ch === '"'){ inQ = !inQ; continue; }
          if(ch === sep && !inQ){ out.push(cur); cur=''; continue; }
          cur += ch;
        }
        out.push(cur);
        return out.map(x=>x.trim());
      });
    }

    function normalizeHeaders(arr){
      return arr.map(h=>{
        const k = h.toLowerCase().replace(/[^a-z0-9]+/g,' ').trim();
        if(/borrower|issuer|name/.test(k)) return 'Borrower';
        if(/sector|industry/.test(k)) return 'Sector';
        if(/exposure|amount|par|face/.test(k)) return 'Exposure';
        if(/status|state/.test(k)) return 'Status';
        if(/test|metric/.test(k)) return 'Test';
        if(/threshold|limit/.test(k)) return 'Threshold';
        if(/value|result|measured/.test(k)) return 'Value';
        if(/as ?of|date/.test(k)) return 'AsOf';
        return h;
      });
    }

    function asDate(s){
      const d = new Date(s);
      return isNaN(d) ? null : d;
    }

    // ---------- State ----------
    let rows = []; // normalized rows

    // ---------- DOM refs ----------
    const file = $('file'), raw = $('raw'), sep = $('sep');
    const recency = $('recency'), conc = $('conc');
    const tbody = $('tbody');
    const chartSector = $('chartSector'), chartStatus = $('chartStatus');

    // ---------- Actions ----------
    $('loadSample').onclick = ()=>{
      raw.value = `Borrower,Sector,Exposure,Status,Test,Threshold,Value,AsOf
Acme Corp,Healthcare,2500000,In Compliance,Net Leverage,4.5x,3.8x,${today.toISOString().slice(0,10)}
Bravo LLC,Software,3200000,At Risk,FCCR,1.20x,1.25x,${new Date(today.getTime()-30*864e5).toISOString().slice(0,10)}
Charlie Inc,Industrials,1800000,Breach,Net Leverage,4.5x,5.1x,${new Date(today.getTime()-70*864e5).toISOString().slice(0,10)}
Delta Co,Healthcare,1200000,In Compliance,Fixed Charge,1.15x,1.30x,${new Date(today.getTime()-100*864e5).toISOString().slice(0,10)}
Echo Ltd,Software,4200000,At Risk,Net Leverage,4.5x,4.4x,${new Date(today.getTime()-95*864e5).toISOString().slice(0,10)}`;
    };

    $('parse').onclick = ()=>{
      let text = raw.value.trim();
      if(!text && file.files[0]){
        const reader = new FileReader();
        reader.onload = e => { raw.value = e.target.result; parseNow(); };
        reader.readAsText(file.files[0]);
      }else{
        parseNow();
      }
    };

    function parseNow(){
      const s = sep.value;
      const data = splitRows(raw.value.trim(), s==='tab'? '\t': s || ',');
      if(data.length===0){ return; }
      const headers = normalizeHeaders(data[0]);
      const idx = Object.fromEntries(headers.map((h,i)=>[h,i]));
      rows = data.slice(1).map((r,i)=>({
        Borrower: r[idx['Borrower']] ?? '',
        Sector: r[idx['Sector']] ?? '',
        Exposure: parseNumber(r[idx['Exposure']]),
        Status: (r[idx['Status']] || '').trim() || 'Unknown',
        Test: (r[idx['Test']] || '').trim(),
        Threshold: (r[idx['Threshold']] || '').trim(),
        Value: (r[idx['Value']] || '').trim(),
        AsOf: (r[idx['AsOf']] || '').trim()
      })).filter(x=>x.Borrower || isFinite(x.Exposure));

      render();
    }

    $('download').onclick = ()=>{
      if(!rows.length) return;
      const headers = ['Borrower','Sector','Exposure','Status','Test','Threshold','Value','AsOf'];
      const csv = [headers.join(',')]
        .concat(rows.map(r=>headers.map(h=>{
          const v = (''+(r[h]??'')).replace(/"/g,'""');
          return /[",\n]/.test(v)? `"${v}"`: v;
        }).join(',')))
        .join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'portfolio_monitor.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    };

    // ---------- Rendering ----------
    function render(){
      // Table
      tbody.innerHTML = '';
      rows.forEach((r,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${r.Borrower||''}</td>
          <td>${r.Sector||''}</td>
          <td style="text-align:right">${money(r.Exposure)}</td>
          <td>${r.Status||''}</td>
          <td>${r.Test||''}</td>
          <td>${r.Threshold||''}</td>
          <td>${r.Value||''}</td>
          <td>${r.AsOf||''}</td>
        `;
        tbody.appendChild(tr);
      });

      // Metrics
      const total = rows.reduce((s,r)=> s + (isFinite(r.Exposure)? r.Exposure:0), 0);
      const borrowers = new Set(rows.map(r=>r.Borrower)).size;
      const sectors = new Set(rows.map(r=>r.Sector)).size;
      const breaches = rows.filter(r=>/breach/i.test(r.Status)).length;
      const atRisk = rows.filter(r=>/risk/i.test(r.Status)).length;

      const byBorrower = aggregate(rows, 'Borrower', 'Exposure');
      const topBorrower = byBorrower.sort((a,b)=>b.value-a.value)[0];
      const topConc = topBorrower && total>0 ? (topBorrower.value/total*100) : 0;

      $('m_total').textContent = money(total);
      $('m_borrowers').textContent = fmt(borrowers);
      $('m_sectors').textContent = fmt(sectors);
      $('m_breaches').textContent = fmt(breaches);
      $('m_risk').textContent = fmt(atRisk);
      $('m_topconc').textContent = isFinite(topConc)? topConc.toFixed(1)+'%':'–';

      // Alerts
      renderAlerts(total, topConc, breaches, atRisk);

      // Charts
      drawSectorChart(rows);
      drawStatusChart(rows);
    }

    function aggregate(arr, key, numKey){
      const m = new Map();
      for(const r of arr){
        const k = (r[key]||'Unknown').trim() || 'Unknown';
        const v = isFinite(r[numKey]) ? +r[numKey] : 0;
        m.set(k, (m.get(k)||0)+v);
      }
      return [...m.entries()].map(([k,v])=>({label:k, value:v}));
    }

    function renderAlerts(total, topConc, breaches, atRisk){
      const wrap = $('alerts');
      wrap.innerHTML = '';
      const warnConc = +$('conc').value || 20;
      const staleDays = +$('recency').value || 90;

      const alerts = [];

      if(isFinite(topConc) && topConc >= warnConc){
        alerts.push({type:'warn', text:`Top borrower concentration ${topConc.toFixed(1)}% ≥ ${warnConc}% threshold.`});
      }
      if(breaches>0){
        alerts.push({type:'danger', text:`${breaches} deal(s) in Breach — immediate review required.`});
      }
      if(atRisk>0){
        alerts.push({type:'warn', text:`${atRisk} deal(s) marked At Risk.`});
      }

      // stale certificates (AsOf older than staleDays)
      const staleCut = new Date(today.getTime() - staleDays*86400000);
      const stale = rows.filter(r=>{
        const d = asDate(r.AsOf);
        return d && d < staleCut;
      }).length;
      if(stale>0){
        alerts.push({type:'warn', text:`${stale} certificate(s) older than ${staleDays} days.`});
      }

      if(alerts.length===0){
        const ok = document.createElement('div');
        ok.className = 'alert';
        ok.innerHTML = '✅ No alerts — portfolio looks clean.';
        wrap.appendChild(ok);
        return;
      }

      for(const a of alerts){
        const div = document.createElement('div');
        div.className = 'alert' + (a.type==='danger'?' danger':'');
        div.innerHTML = (a.type==='danger'?'⛔':'⚠️') + ' ' + a.text;
        wrap.appendChild(div);
        wrap.appendChild(document.createElement('div')).style.height='8px';
      }
    }

    // Simple bar charts (no external libs)
    function drawBars(ctx, labels, values){
      const W = ctx.canvas.width, H = ctx.canvas.height;
      const max = Math.max(1, ...values);
      const pad = 30, gap = 12;
      const n = values.length;
      const barW = (W - pad*2 - gap*(n-1)) / Math.max(1,n);

      ctx.clearRect(0,0,W,H);
      ctx.font = '12px Poppins, sans-serif';
      ctx.fillStyle = '#333';
      // axis
      ctx.beginPath();
      ctx.moveTo(pad, H-pad);
      ctx.lineTo(W-pad, H-pad);
      ctx.strokeStyle = '#ddd';
      ctx.stroke();

      // bars
      for(let i=0;i<n;i++){
        const x = pad + i*(barW+gap);
        const h = (H - pad*2) * (values[i] / max);
        const y = (H - pad) - h;
        ctx.fillStyle = '#2c7cf1';
        ctx.fillRect(x, y, barW, h);
        // label
        ctx.fillStyle = '#555';
        const lbl = labels[i].length>10 ? labels[i].slice(0,10)+'…' : labels[i];
        ctx.fillText(lbl, x, H-pad+14);
      }
    }

    function drawSectorChart(rows){
      const agg = aggregate(rows, 'Sector', 'Exposure').sort((a,b)=>b.value-a.value).slice(0,8);
      const labels = agg.map(x=>x.label);
      const vals = agg.map(x=>x.value);
      const ctx = chartSector.getContext('2d');
      drawBars(ctx, labels, vals);
    }

    function drawStatusChart(rows){
      const counts = new Map();
      for(const r of rows){
        const k = (r.Status||'Unknown').trim() || 'Unknown';
        counts.set(k, (counts.get(k)||0)+1);
      }
      const arr = [...counts.entries()].map(([label,value])=>({label,value})).sort((a,b)=>b.value-a.value);
      const labels = arr.map(x=>x.label);
      const vals = arr.map(x=>x.value);
      const ctx = chartStatus.getContext('2d');
      drawBars(ctx, labels, vals);
    }

    // File -> textarea convenience
    file.addEventListener('change', ()=>{
      if(file.files[0]){
        const reader = new FileReader();
        reader.onload = e => { raw.value = e.target.result; };
        reader.readAsText(file.files[0]);
      }
    });

    // initial: load sample so users see behavior
    $('loadSample').click();
    $('parse').click();
  })();
  </script>
</body>
</html>
