<script>
// Fetch + render
const API = '/api/media-feed';
let _items = [];

function timeAgo(iso){
  const d = new Date(iso);
  const diffMs = Date.now() - d.getTime();
  const m = Math.round(diffMs/60000);
  if (m < 60) return `${m}m`;
  const h = Math.round(m/60);
  if (h < 24) return `${h}h`;
  return `${Math.round(h/24)}d`;
}

function tagPills(tags=[]){
  if (!tags.length) return '';
  return `<span class="card-tags">${tags.join(' Â· ')}</span>`;
}

// === Source badge helpers (place them before render functions) ===
const SOURCE_BADGES = {
  'privatedebtinvestor.com': {label:'PDI', cls:'pdi'},
  'hedgeweek.com': {label:'Hedgeweek', cls:'hedgeweek'},
  'alpha-week.com': {label:'AlphaWeek', cls:'alphaweek'},
  'livewiremarkets.com': {label:'Livewire', cls:'livewire'},
  'privatemarketsreview.substack.com': {label:'PM Review', cls:'pmreview'},
  'privatemarketsmagazine.com': {label:'PM Magazine', cls:'pmmag'},
  'globalcapital.com': {label:'GlobalCapital', cls:'globalcapital'},
  'reuters.com': {label:'Reuters', cls:'reuters'},
  'bloomberg.com': {label:'Bloomberg', cls:'bloomberg'},
  'ft.com': {label:'FT', cls:'ft'},
  'wsj.com': {label:'WSJ', cls:'wsj'},
  'barrons.com': {label:"Barron's", cls:'barrons'},
  'spglobal.com': {label:'S&P Global', cls:'spglobal'},
  'altcreditinvestor.com': {label:'Alt Credit Investor', cls:'aci'}
};

// Paywall-ish publishers
const PAYWALLED = new Set(['ft.com','wsj.com','barrons.com']);

function prettyHost(host=''){
  return String(host||'').replace(/^www\./,'');
}

function badgeHTML(host=''){
  const key = prettyHost(host);
  const meta = SOURCE_BADGES[key] || {label: key || 'Source', cls: 'other'};
  const lock = PAYWALLED.has(key) ? '<span class="lock">ðŸ”’</span>' : '';
  return `<span class="badge badge--${meta.cls}" title="${meta.label}">${meta.label}${lock}</span>`;
}

// === Renderers ===
function renderTop10(items){
  const el = document.getElementById('top10');
  el.innerHTML = items.slice(0,10).map(i => `
    <a class="card" href="${i.url}" target="_blank" rel="noopener">
      <div class="card-title">${i.title}</div>
      <div class="card-meta">${badgeHTML(i.source||'')} ${timeAgo(i.published_at||i.pubDate||Date.now())}</div>
      ${tagPills(i.tags)}
    </a>
  `).join('');
}

function renderFeed(items){
  const el = document.getElementById('feed');
  el.innerHTML = items.map(i => `
    <a href="${i.url}" target="_blank" rel="noopener">
      <span>${badgeHTML(i.source||'')}${i.title}</span>
      <span class="right">${timeAgo(i.published_at||i.pubDate||Date.now())}</span>
    </a>
  `).join('');
}

// === Tag normalization ===
const TAG_ALIASES = {
  "pe":"Private Equity","private-equity":"Private Equity","private equity":"Private Equity",
  "re":"Real Estate","real-estate":"Real Estate","real estate":"Real Estate",
  "infra":"Infrastructure","infrastructure":"Infrastructure",
  "em":"Emerging Markets","emerging-markets":"Emerging Markets","emerging markets":"Emerging Markets",
  "direct lending":"Direct Lending","clo":"CLO","nav":"NAV","bdc":"BDC","abs":"ABS"
};

function normalizeTag(s="") {
  const k = String(s).trim().toLowerCase();
  return TAG_ALIASES[k] || s;
}
function toTagArray(t){
  if (Array.isArray(t)) return t;
  if (typeof t === 'string') return t.split(',').map(x => x.trim()).filter(Boolean);
  return [];
}
function inferTagsFromText(text="") {
  const t = text.toLowerCase(); const out = new Set();
  if (/(private\s*equity|\bpe\b|buyout|leveraged buyout|sponsor-backed)/.test(t)) out.add("Private Equity");
  if (/(real\s*estate|\breit\b|multifamily|office|industrial|property|mortgage|construction loan)/.test(t)) out.add("Real Estate");
  if (/(infrastructure|data center|renewable|solar|wind|transmission|toll road|airport|port|pipeline)/.test(t)) out.add("Infrastructure");
  if (/(emerging markets|\bem\b|latam|latin america|india|asean|africa|mena|ceemea|turkey|brazil|mexico)/.test(t)) out.add("Emerging Markets");
  if (/(direct lending)/.test(t)) out.add("Direct Lending");
  if (/\bclo\b/.test(t)) out.add("CLO");
  if (/\bnav\b/.test(t)) out.add("NAV");
  if (/\bbdc\b/.test(t)) out.add("BDC");
  if (/\babs\b/.test(t)) out.add("ABS");
  return Array.from(out);
}

// === Filtering ===
function applyFilter(tag='All'){
  const selected = normalizeTag(tag);
  const filtered = selected==='All'
    ? _items
    : _items.filter(i => {
        const tags = toTagArray(i.tags).map(t => normalizeTag(t));
        return tags.includes(selected);
      });
  renderTop10(filtered);
  renderFeed(filtered.slice(10, 260));
}

// === Data load ===
async function loadFeed(){
  try{
    const res = await fetch(API, { cache: 'no-store' });
    const data = await res.json();
    _items = (data.items || []).map(i => {
      const baseTags = toTagArray(i.tags);
      const inferred = inferTagsFromText([i.title, i.summary, i.description].filter(Boolean).join(' '));
      const merged = Array.from(new Set([...baseTags, ...inferred]));
      return { ...i, tags: merged };
    }).sort((a,b)=> new Date(b.published_at||b.pubDate) - new Date(a.published_at||a.pubDate));
    applyFilter('All');
  }catch(e){ console.error('Feed load error', e); }
}

function updateLastUpdated() {
  const now = new Date();
  const formatted = now.toLocaleString('en-US', { hour:'numeric', minute:'2-digit', hour12:true, month:'short', day:'numeric' });
  const el = document.getElementById('last-updated');
  if (el) el.textContent = `Last updated: ${formatted}`;
}

// === Init ===
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('#filters .pill').forEach(btn=>{
    btn.addEventListener('click', () => {
      document.querySelectorAll('#filters .pill').forEach(b=>b.classList.remove('pill--active'));
      btn.classList.add('pill--active');
      applyFilter(btn.dataset.tag);
    });
  });
  loadFeed().then(updateLastUpdated);
});

// Debug helper
window.__tags = function(){
  const counts = {};
  (_items||[]).forEach(i => (i.tags||[]).forEach(t => counts[t] = (counts[t]||0)+1));
  console.table(counts);
};
</script>
