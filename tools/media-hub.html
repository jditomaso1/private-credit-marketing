<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>News | Private Credit AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="/img/favicon.png?v=8">

  <style>
    /* Base */
    * { box-sizing: border-box; }
    body { font-family:Poppins, sans-serif; margin:0; background:#f4f4f4; color:#333; }

    /* Page wrapper (same width as tools pages) */
    .page{max-width:1100px;margin:24px auto 0;padding:12px 20px 0}

    /* Tools sub-nav (same as other tool pages) */
    .tool-tabs{margin:0 0 8px;display:flex;gap:8px;flex-wrap:wrap}
    .tool-tab{display:inline-block;padding:10px 14px;border:1px solid #ddd;border-radius:8px;background:#fff;text-decoration:none;color:#111;font-size:14px}
    .tool-tab.active{background:#111;color:#fff;border-color:#111}

    /* === Media Hub === */
    #media-hub { max-width:1100px; margin:0 auto; padding:0 20px 40px; }
    #media-hub a { color:#111; text-decoration:none; }
    #media-hub a:hover { color:#2c7cf1; text-decoration:underline; }

    /* Reduce space between tool-tabs and Media Hub heading */
    #media-hub header {
      margin-top: 0; /* smaller gap */
    }

    #media-hub h1 {
      margin-top: 0;   /* remove extra margin */
    }

    .pill{border:1px solid #d5d8dd;background:#fff;color:#222;border-radius:999px;padding:8px 12px;font-size:13px;cursor:pointer}
    .pill--active{background:#2c7cf1;color:#fff;border-color:#2c7cf1}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}
    @media (max-width: 820px){ .grid{grid-template-columns:1fr} }
    .card{background:#fff;border:1px solid #eee;border-radius:10px;padding:14px;display:block;color:#111}
    .card:hover{box-shadow:0 6px 20px rgba(0,0,0,.08);transform:translateY(-1px);transition:all .15s}
    .card-title{font-weight:600;margin:0 0 6px 0;line-height:1.3}
    .card-meta{font-size:12px;color:#666;margin:0 0 6px 0}
    .card-tags{font-size:12px;color:#666}
    .list a{display:flex;justify-content:space-between;gap:12px;border-bottom:1px solid #eee;padding:10px 0;color:#111}
    .list a:hover{background:#fafbfc}
    .list .right{white-space:nowrap;color:#666;font-size:12px}
    #refresh-btn{display:inline-block !important;}
  </style>
</head>
<body>

  <!-- Shared header (master-header-basic) -->
  <div id="site-header"></div>

  <!-- Tools sub-nav -->
  <main class="page">
    <nav class="tool-tabs" aria-label="Tools">
      <a class="tool-tab" href="/tools/media-hub.html">Media Hub</a>
      <a class="tool-tab" href="/tools/irr-calculator.html">IRR Calculator</a>
      <a class="tool-tab" href="/tools/yield-curve.html">Yield Curve</a>
      <a class="tool-tab" href="/tools/credit-decoder.html">Credit Decoder</a>
      <a class="tool-tab" href="/tools/loan-pricing.html">Loan Pricing</a>
      <a class="tool-tab" href="/tools/covenant-checker.html">Covenant Checker</a>
    </nav>
    <script>
      (function(){
        const here = location.pathname.replace(/\/+$/,'');
        document.querySelectorAll('.tool-tab').forEach(a=>{
          if(a.getAttribute('href')===here){ a.classList.add('active'); }
        });
      })();
    </script>
  </main>

  <!-- Media Hub -->
  <section id="media-hub">
    <header style="margin-bottom:16px;">
      <h1 style="margin:0 0 6px 0;font-size:32px;font-weight:700;">Media Hub</h1>
      <p style="margin:0;color:#555;">Top headlines in private credit â€” updated hourly. Click to read at the source.</p>
      <button id="refresh-btn" onclick="location.reload()"
              style="padding:6px 12px;background:#2c7cf1;color:#fff;border:none;border-radius:4px;cursor:pointer;margin-top:12px;">
        ðŸ”„ Refresh News
      </button>
      <p id="last-updated" style="margin-top:8px; color:#666; font-size:13px;"></p>
    </header>

    <!-- Filters -->
    <nav id="filters" style="display:flex;gap:10px;flex-wrap:wrap;margin:18px 0 22px;">
      <button data-tag="All" class="pill pill--active">All</button>
      <button data-tag="Direct Lending" class="pill">Direct Lending</button>
      <button data-tag="CLO" class="pill">CLO</button>
      <button data-tag="NAV" class="pill">NAV</button>
      <button data-tag="BDC" class="pill">BDC</button>
      <button data-tag="ABS" class="pill">ABS</button>
      <button data-tag="Private Equity" class="pill">Private Equity</button>
      <button data-tag="Real Estate" class="pill">Real Estate</button>
      <button data-tag="Infrastructure" class="pill">Infrastructure</button>
      <button data-tag="Emerging Markets" class="pill">Emerging Markets</button>
    </nav>

    <h3 style="margin:10px 0 12px;font-size:20px;">Top 10 Today</h3>
    <div id="top10" class="grid"></div>

    <h3 style="margin:28px 0 12px;font-size:20px;">All Stories</h3>
    <div id="feed" class="list"></div>
  </section>

  <!-- Shared footer (master-header-basic) -->
  <div id="site-footer"></div>
  <script src="/includes/include.js"></script>

  <script>
  // Fetch + render
  const API = '/api/media-feed';
  let _items = [];

  function timeAgo(iso){
    const d = new Date(iso);
    const diffMs = Date.now() - d.getTime();
    const m = Math.round(diffMs/60000);
    if (m < 60) return `${m}m`;
    const h = Math.round(m/60);
    if (h < 24) return `${h}h`;
    return `${Math.round(h/24)}d`;
  }

  function tagPills(tags=[]){
    if (!tags.length) return '';
    return `<span class="card-tags">${tags.join(' Â· ')}</span>`;
  }

  function renderTop10(items){
    const el = document.getElementById('top10');
    el.innerHTML = items.slice(0,10).map(i => `
      <a class="card" href="${i.url}" target="_blank" rel="noopener">
        <div class="card-title">${i.title}</div>
        <div class="card-meta">${(i.source||'').replace(/^www\\./,'')} Â· ${timeAgo(i.published_at||i.pubDate||Date.now())}</div>
        ${tagPills(i.tags)}
      </a>
    `).join('');
  }

  function renderFeed(items){
    const el = document.getElementById('feed');
    el.innerHTML = items.map(i => `
      <a href="${i.url}" target="_blank" rel="noopener">
        <span>${i.title}</span>
        <span class="right">${(i.source||'').replace(/^www\\./,'')} Â· ${timeAgo(i.published_at||i.pubDate||Date.now())}</span>
      </a>
    `).join('');
  }

  const TAG_ALIASES = {
    "pe":"Private Equity","private-equity":"Private Equity","private equity":"Private Equity",
    "re":"Real Estate","real-estate":"Real Estate","real estate":"Real Estate",
    "infra":"Infrastructure","infrastructure":"Infrastructure",
    "em":"Emerging Markets","emerging-markets":"Emerging Markets","emerging markets":"Emerging Markets",
    "direct lending":"Direct Lending","clo":"CLO","nav":"NAV","bdc":"BDC","abs":"ABS"
  };

  function normalizeTag(s="") {
    const k = String(s).trim().toLowerCase();
    return TAG_ALIASES[k] || s;
  }
  function toTagArray(t){
    if (Array.isArray(t)) return t;
    if (typeof t === 'string') return t.split(',').map(x => x.trim()).filter(Boolean);
    return [];
  }
  function inferTagsFromText(text="") {
    const t = text.toLowerCase(); const out = new Set();
    if (/(private\s*equity|\bpe\b|buyout|leveraged buyout|sponsor-backed)/.test(t)) out.add("Private Equity");
    if (/(real\s*estate|\breit\b|multifamily|office|industrial|property|mortgage|construction loan)/.test(t)) out.add("Real Estate");
    if (/(infrastructure|data center|renewable|solar|wind|transmission|toll road|airport|port|pipeline)/.test(t)) out.add("Infrastructure");
    if (/(emerging markets|\bem\b|latam|latin america|india|asean|africa|mena|ceemea|turkey|brazil|mexico)/.test(t)) out.add("Emerging Markets");
    if (/(direct lending)/.test(t)) out.add("Direct Lending");
    if (/\bclo\b/.test(t)) out.add("CLO");
    if (/\bnav\b/.test(t)) out.add("NAV");
    if (/\bbdc\b/.test(t)) out.add("BDC");
    if (/\babs\b/.test(t)) out.add("ABS");
    return Array.from(out);
  }

  function applyFilter(tag='All'){
    const selected = normalizeTag(tag);
    const filtered = selected==='All'
      ? _items
      : _items.filter(i => {
          const tags = toTagArray(i.tags).map(t => normalizeTag(t));
          return tags.includes(selected);
        });
    renderTop10(filtered);
    renderFeed(filtered.slice(10, 260));
  }

  async function loadFeed(){
    try{
      const res = await fetch(API, { cache: 'no-store' });
      const data = await res.json();
      _items = (data.items || []).map(i => {
        const baseTags = toTagArray(i.tags);
        const inferred = inferTagsFromText([i.title, i.summary, i.description].filter(Boolean).join(' '));
        const merged = Array.from(new Set([...baseTags, ...inferred]));
        return { ...i, tags: merged };
      }).sort((a,b)=> new Date(b.published_at||b.pubDate) - new Date(a.published_at||a.pubDate));
      applyFilter('All');
    }catch(e){ console.error('Feed load error', e); }
  }

  function updateLastUpdated() {
    const now = new Date();
    const formatted = now.toLocaleString('en-US', { hour:'numeric', minute:'2-digit', hour12:true, month:'short', day:'numeric' });
    const el = document.getElementById('last-updated');
    if (el) el.textContent = `Last updated: ${formatted}`;
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('#filters .pill').forEach(btn=>{
      btn.addEventListener('click', () => {
        document.querySelectorAll('#filters .pill').forEach(b=>b.classList.remove('pill--active'));
        btn.classList.add('pill--active');
        applyFilter(btn.dataset.tag);
      });
    });
    loadFeed().then(updateLastUpdated);
  });

  // Debug helper
  window.__tags = function(){
    const counts = {};
    (_items||[]).forEach(i => (i.tags||[]).forEach(t => counts[t] = (counts[t]||0)+1));
    console.table(counts);
  };
  </script>
</body>
</html>
