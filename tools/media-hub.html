<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>News | Private Credit AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="/img/favicon.png?v=8">

  <style>
    /* Base */
    * { box-sizing: border-box; }
    body { font-family:Poppins, sans-serif; margin:0; background:#f4f4f4; color:#333; }

    /* Page wrapper (same width as tools pages) */
    .page{max-width:1100px;margin:24px auto 0;padding:12px 20px 0}

    /* Tools sub-nav (same as other tool pages) */
    .tool-tabs{margin:0 0 8px;display:flex;gap:8px;flex-wrap:wrap}
    .tool-tab{display:inline-block;padding:10px 14px;border:1px solid #ddd;border-radius:8px;background:#fff;text-decoration:none;color:#111;font-size:14px}
    .tool-tab.active{background:#111;color:#fff;border-color:#111}

    /* === Media Hub === */
    #media-hub { max-width:1100px; margin:0 auto; padding:0 20px 40px; }
    #media-hub a { color:#111; text-decoration:none; }
    #media-hub a:hover { color:#2c7cf1; text-decoration:underline; }

    /* Reduce space between tool-tabs and Media Hub heading */
    #media-hub header { margin-top: 0; }
    #media-hub h1 { margin-top: 0; }
    #site-header { margin-bottom: 30px; }

    .pill{border:1px solid #d5d8dd;background:#fff;color:#222;border-radius:999px;padding:8px 12px;font-size:13px;cursor:pointer}
    .pill--active{background:#2c7cf1;color:#fff;border-color:#2c7cf1}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}
    @media (max-width: 820px){ .grid{grid-template-columns:1fr} }
    .card{background:#fff;border:1px solid #eee;border-radius:10px;padding:14px;display:block;color:#111}
    .card:hover{box-shadow:0 6px 20px rgba(0,0,0,.08);transform:translateY(-1px);transition:all .15s}
    .card-title{font-weight:600;margin:0 0 6px 0;line-height:1.3}
    .card-meta{font-size:12px;color:#666;margin:0 0 6px 0}
    .card-tags{font-size:12px;color:#666}
    .list a{display:flex;justify-content:space-between;gap:12px;border-bottom:1px solid #eee;padding:10px 0;color:#111}
    .list a:hover{background:#fafbfc}
    .list .right{white-space:nowrap;color:#666;font-size:12px}
    #refresh-btn{display:inline-block !important;}

    /* Source badges */
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;line-height:1.6;border:1px solid #e5e7eb;background:#fff;color:#374151;margin-right:8px;vertical-align:middle}
    .badge--pdi{background:#fff7ed;border-color:#fdba74;color:#9a3412}
    .badge--hedgeweek{background:#eff6ff;border-color:#93c5fd;color:#1d4ed8}
    .badge--alphaweek{background:#eef2ff;border-color:#c7d2fe;color:#3730a3}
    .badge--livewire{background:#ecfdf5;border-color:#6ee7b7;color:#065f46}
    .badge--pmreview{background:#faf5ff;border-color:#e9d5ff;color:#6b21a8}
    .badge--pmmag{background:#f0f9ff;border-color:#bae6fd;color:#0c4a6e}
    .badge--globalcapital{background:#fefce8;border-color:#fde68a;color:#854d0e}
    .badge--reuters{background:#fff1f2;border-color:#fecdd3;color:#be123c}
    .badge--bloomberg{background:#f5f3ff;border-color:#ddd6fe;color:#5b21b6}
    .badge--ft{background:#fff7ed;border-color:#fed7aa;color:#b45309}
    .badge--wsj{background:#ecfeff;border-color:#a5f3fc;color:#155e75}
    .badge--barrons{background:#eef2ff;border-color:#c7d2fe;color:#3730a3}
    .badge--spglobal{background:#fee2e2;border-color:#fecaca;color:#991b1b}
    .badge--aci{background:#f0fdf4;border-color:#bbf7d0;color:#166534}
    .badge--other{background:#f9fafb;border-color:#e5e7eb;color:#374151}
    .badge .lock{margin-left:4px;opacity:.7}
  </style>
</head>
<body>

  <!-- Shared header (master-header-basic) -->
  <div id="site-header"></div>

  <!-- Tools sub-nav -->
  <main class="page">
    <nav class="tool-tabs" aria-label="Tools">
      <a class="tool-tab" href="/tools/media-hub.html">Media Hub</a>
      <a class="tool-tab" href="/tools/irr-calculator.html">IRR Calculator</a>
      <a class="tool-tab" href="/tools/yield-curve.html">Yield Curve</a>
      <a class="tool-tab" href="/tools/credit-decoder.html">Credit Decoder</a>
      <a class="tool-tab" href="/tools/loan-pricing.html">Loan Pricing</a>
      <a class="tool-tab" href="/tools/covenant-checker.html">Covenant Checker</a>
    </nav>
    <script>
      (function(){
        const here = location.pathname.replace(/\/+$/,'');
        document.querySelectorAll('.tool-tab').forEach(a=>{
          if(a.getAttribute('href')===here){ a.classList.add('active'); }
        });
      })();
    </script>
  </main>

  <!-- Media Hub -->
  <section id="media-hub">
    <header style="margin-bottom:16px;">
      <h1 style="margin:0 0 6px 0;font-size:32px;font-weight:700;">Media Hub</h1>
      <p style="margin:0;color:#555;">Top headlines in private credit — updated hourly. Click to read at the source.</p>
      <button id="refresh-btn" onclick="location.reload()"
              style="padding:6px 12px;background:#2c7cf1;color:#fff;border:none;border-radius:4px;cursor:pointer;margin-top:12px;">
        🔄 Refresh News
      </button>
      <p id="last-updated" style="margin-top:8px; color:#666; font-size:13px;"></p>
    </header>

    <!-- Filters -->
    <nav id="filters" style="display:flex;gap:10px;flex-wrap:wrap;margin:18px 0 22px;">
      <button data-tag="All" class="pill pill--active">All</button>
      <button data-tag="Direct Lending" class="pill">Direct Lending</button>
      <button data-tag="CLO" class="pill">CLO</button>
      <button data-tag="NAV" class="pill">NAV</button>
      <button data-tag="BDC" class="pill">BDC</button>
      <button data-tag="ABS" class="pill">ABS</button>
      <button data-tag="Private Equity" class="pill">Private Equity</button>
      <button data-tag="Real Estate" class="pill">Real Estate</button>
      <button data-tag="Infrastructure" class="pill">Infrastructure</button>
      <button data-tag="Emerging Markets" class="pill">Emerging Markets</button>
    </nav>

    <h3 style="margin:10px 0 12px;font-size:20px;">Top 10 Today</h3>
    <div id="top10" class="grid"></div>

    <h3 style="margin:28px 0 12px;font-size:20px;">All Stories</h3>
    <div id="feed" class="list"></div>
  </section>

  <!-- Shared footer (master-header-basic) -->
  <div id="site-footer"></div>
  <script src="/includes/include.js"></script>

  <!-- Single app script (no nested <script> inside!) -->
  <script>
  // ===== Config =====
  const API = '/api/media-feed';
  let _items = [];

  // ===== Utilities =====
  function timeAgo(iso){
    const d = new Date(iso);
    const diffMs = Date.now() - d.getTime();
    const m = Math.round(diffMs/60000);
    if (m < 60) return `${m}m`;
    const h = Math.round(m/60);
    if (h < 24) return `${h}h`;
    return `${Math.round(h/24)}d`;
  }

  function tagPills(tags=[]){
    if (!tags.length) return '';
    return `<span class="card-tags">${tags.join(' · ')}</span>`;
  }

  // ===== Source badge helpers =====
  const SOURCE_BADGES = {
    'privatedebtinvestor.com': {label:'PDI', cls:'pdi'},
    'hedgeweek.com': {label:'Hedgeweek', cls:'hedgeweek'},
    'alpha-week.com': {label:'AlphaWeek', cls:'alphaweek'},
    'livewiremarkets.com': {label:'Livewire', cls:'livewire'},
    'privatemarketsreview.substack.com': {label:'PM Review', cls:'pmreview'},
    'privatemarketsmagazine.com': {label:'PM Magazine', cls:'pmmag'},
    'globalcapital.com': {label:'GlobalCapital', cls:'globalcapital'},
    'reuters.com': {label:'Reuters', cls:'reuters'},
    'bloomberg.com': {label:'Bloomberg', cls:'bloomberg'},
    'ft.com': {label:'FT', cls:'ft'},
    'wsj.com': {label:'WSJ', cls:'wsj'},
    'barrons.com': {label:"Barron's", cls:'barrons'},
    'spglobal.com': {label:'S&P Global', cls:'spglobal'},
    'altcreditinvestor.com': {label:'Alt Credit Investor', cls:'aci'}
  };
  const PAYWALLED = new Set(['ft.com','wsj.com','barrons.com']);

  function prettyHost(host=''){ return String(host||'').replace(/^www\./,''); }
  function badgeHTML(host=''){
    const key = prettyHost(host);
    const meta = SOURCE_BADGES[key] || {label: key || 'Source', cls: 'other'};
    const lock = PAYWALLED.has(key) ? '<span class="lock">🔒</span>' : '';
    return `<span class="badge badge--${meta.cls}" title="${meta.label}">${meta.label}${lock}</span>`;
  }
  // Fallback to the article URL’s hostname if source is news.google.com
  function hostFromItem(i){
    const s = prettyHost(i.source || '');
    if (s && s !== 'news.google.com') return s;
    try { return new URL(i.url).hostname.replace(/^www\./,''); } catch { return s || ''; }
  }

  // -- Canonicalize GN links on the client (belt-and-suspenders) --
  function rewriteGoogleNewsUrl(u=''){
    try{
      const url = new URL(u);
      if (url.hostname.endsWith('news.google.com')){
        const orig = url.searchParams.get('url') || url.searchParams.get('q');
        if (orig){
          try { return decodeURIComponent(orig); } catch { return orig; }
        }
      }
    }catch{}
    return u;
  }
  
  function massageItem(i){
    // If API left a GN URL, rewrite it here and recompute source
    const newUrl = rewriteGoogleNewsUrl(i.url || '');
    if (newUrl !== (i.url || '')){
      i = { ...i, url: newUrl };
      try { i.source = new URL(newUrl).hostname.replace(/^www\./,''); } catch {}
    }
    return i;
  }
    
  // ===== Renderers =====
  function renderTop10(items){
    const el = document.getElementById('top10');
    el.innerHTML = items.slice(0,10).map(i => {
      const host = hostFromItem(i);
      return `
        <a class="card" href="${i.url}" target="_blank" rel="noopener">
          <div class="card-title">${i.title}</div>
          let host = '';
          try { host = new URL(i.url).hostname.replace(/^www\./,''); } catch {}
          <div class="card-meta">${badgeHTML(host)} ${timeAgo(...)} </div>
          ${tagPills(i.tags)}
        </a>
      `;
    }).join('');
  }

function renderFeed(items){
  const el = document.getElementById('feed');
  el.innerHTML = items.map(i => {
    // Always prefer the hostname of the actual article URL
    let host = '';
    try { host = new URL(i.url).hostname.replace(/^www\./,''); } catch {}
    return `
      <a href="${i.url}" target="_blank" rel="noopener">
        <span>${badgeHTML(host)}${i.title}</span>
        <span class="right">${host} · ${timeAgo(i.published_at||i.pubDate||Date.now())}</span>
      </a>
    `;
  }).join('');
}

  // ===== Tag normalization =====
  const TAG_ALIASES = {
    "pe":"Private Equity","private-equity":"Private Equity","private equity":"Private Equity",
    "re":"Real Estate","real-estate":"Real Estate","real estate":"Real Estate",
    "infra":"Infrastructure","infrastructure":"Infrastructure",
    "em":"Emerging Markets","emerging-markets":"Emerging Markets","emerging markets":"Emerging Markets",
    "direct lending":"Direct Lending","clo":"CLO","nav":"NAV","bdc":"BDC","abs":"ABS"
  };
  function normalizeTag(s=""){ const k = String(s).trim().toLowerCase(); return TAG_ALIASES[k] || s; }
  function toTagArray(t){ if (Array.isArray(t)) return t; if (typeof t === 'string') return t.split(',').map(x=>x.trim()).filter(Boolean); return []; }
  function inferTagsFromText(text=""){
    const t = text.toLowerCase(); const out = new Set();
    if (/(private\s*equity|\bpe\b|buyout|leveraged buyout|sponsor-backed)/.test(t)) out.add("Private Equity");
    if (/(real\s*estate|\breit\b|multifamily|office|industrial|property|mortgage|construction loan)/.test(t)) out.add("Real Estate");
    if (/(infrastructure|data center|renewable|solar|wind|transmission|toll road|airport|port|pipeline)/.test(t)) out.add("Infrastructure");
    if (/(emerging markets|\bem\b|latam|latin america|india|asean|africa|mena|ceemea|turkey|brazil|mexico)/.test(t)) out.add("Emerging Markets");
    if (/(direct lending)/.test(t)) out.add("Direct Lending");
    if (/\bclo\b/.test(t)) out.add("CLO");
    if (/\bnav\b/.test(t)) out.add("NAV");
    if (/\bbdc\b/.test(t)) out.add("BDC");
    if (/\babs\b/.test(t)) out.add("ABS");
    return Array.from(out);
  }

  // ===== Filtering =====
  function applyFilter(tag='All'){
    const selected = normalizeTag(tag);
    const filtered = selected==='All'
      ? _items
      : _items.filter(i => {
          const tags = toTagArray(i.tags).map(t => normalizeTag(t));
          return tags.includes(selected);
        });
    renderTop10(filtered);
    renderFeed(filtered.slice(10, 260));
  }

  // ===== Data load =====
  async function loadFeed(){
    try{
      const res = await fetch(`${API}?ts=${Date.now()}`, { cache: 'no-store' });
      if (!res.ok) throw new Error(`Feed HTTP ${res.status}`);
      const data = await res.json();
      _items = (data.items || []).map(i => {
        const baseTags = toTagArray(i.tags);
        const inferred = inferTagsFromText([i.title, i.summary, i.description].filter(Boolean).join(' '));
        const merged = Array.from(new Set([...baseTags, ...inferred]));
        return massageItem({ ...i, tags: merged });
      }).sort((a,b)=> new Date(b.published_at||b.pubDate) - new Date(a.published_at||a.pubDate));
      applyFilter('All');
    }catch(e){
      console.error('Feed load error', e);
      const feed = document.getElementById('feed');
      if (feed) feed.innerHTML = `<div style="color:#b91c1c">⚠️ Failed to load feed: ${e.message}</div>`;
    }
  }

  function updateLastUpdated() {
    const now = new Date();
    const formatted = now.toLocaleString('en-US', { hour:'numeric', minute:'2-digit', hour12:true, month:'short', day:'numeric' });
    const el = document.getElementById('last-updated');
    if (el) el.textContent = `Last updated: ${formatted}`;
  }

  // ===== Init =====
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('#filters .pill').forEach(btn=>{
      btn.addEventListener('click', () => {
        document.querySelectorAll('#filters .pill').forEach(b=>b.classList.remove('pill--active'));
        btn.classList.add('pill--active');
        applyFilter(btn.dataset.tag);
      });
    });
    loadFeed().then(updateLastUpdated);
  });

  // Debug helper
  window.__tags = function(){
    const counts = {};
    (_items||[]).forEach(i => (i.tags||[]).forEach(t => counts[t] = (counts[t]||0)+1));
    console.table(counts);
  };
  </script>
</body>
</html>
